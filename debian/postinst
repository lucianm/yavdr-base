#!/bin/bash -e

case "$1" in
  configure)

  # conffiles
  . /usr/share/yavdr/helpers/conffiles
  install_conffile yavdr-base /etc/acpi/powerbtn.sh
  install_conffile yavdr-base /etc/default/grub
  install_conffile yavdr-base /etc/logrotate.conf
  install_conffile yavdr-base /etc/update-manager/release-upgrades

  # prefill hdf
  yavdr-db-tool -a preset -k system.grub.options -v "vmalloc=256m nohz=off acpi_enforce_resources=lax"
  yavdr-db-tool -a preset -k system.shutdown.method -v "s3"
  yavdr-db-tool -a preset -k system.wakeup.method -v "acpi"
  yavdr-db-tool -a preset -k system.wakeup.disable_usb -v "1"

  # temlate files
  /usr/bin/yavdr-template-base

  # update grub
  /usr/sbin/update-grub

  # add yavdr group
  if ! getent group | grep -q "^yavdr:" ; then
    addgroup --quiet --gid 999 --system yavdr
  fi
  # add yavdr user
  if ! getent passwd | grep -q "^yavdr:"; then
    adduser --system --uid 999 --home /yavdr --shell /bin/bash --gecos "yaVDR user" --ingroup yavdr yavdr
    # default password is yavdr
    usermod -p "\$6\$sAxoZXNf\$8eHcSic1cP/b.Dmn5BCrEg5FJbA/SKXobA3/UUK7EeXGBGOdwc11ZGRnkDxjmOVsXyxXKi1kDIzNPZu1Q9ree/" yavdr
  fi

  # add yavdr to some groups
  adduser yavdr video
  adduser yavdr audio
  adduser yavdr cdrom
  adduser yavdr plugdev
  ;;

esac

exit 0
